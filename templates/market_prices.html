{% extends "base.html" %}
{% block title %}Market Prices – AgroMate{% endblock %}

{% block content %}

<!-- Page Hero -->
<section class="page-hero">
  <div class="page-hero-overlay"></div>
  <div class="container text-center">
    <span class="section-tag-light" data-aos="fade-up">LIVE DATA</span>
    <h1 class="page-hero-title" data-aos="fade-up" data-aos-delay="100">Market Prices</h1>
    <p class="page-hero-subtitle" data-aos="fade-up" data-aos-delay="200">
      Real-time mandi prices from data.gov.in across India.
    </p>
    <nav aria-label="breadcrumb" data-aos="fade-up" data-aos-delay="300">
      <ol class="breadcrumb justify-content-center">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Market Prices</li>
      </ol>
    </nav>
  </div>
</section>

<!-- Main Content -->
<section class="section-padding">
  <div class="container">

    <!-- Search Form -->
    <div class="market-search-card tool-card mb-5" data-aos="fade-up">
      <div class="tool-card-header">
        <div class="tool-icon" style="background: linear-gradient(135deg,#16a34a,#15803d);">
          <i class="bi bi-shop"></i>
        </div>
        <div>
          <h4 class="mb-0">Search Mandi Prices</h4>
          <p class="text-muted small mb-0">Filter by commodity, location and date range</p>
        </div>
      </div>

      <form method="POST" action="{{ url_for('market_prices') }}" class="mt-4" id="marketForm">
        <!-- Row 1: State, District, Commodity -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-geo-alt me-2 text-success"></i>State
            </label>
            <input type="text" name="state" class="form-control"
                   placeholder="e.g. Maharashtra" value="{{ state }}">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-pin-map me-2 text-success"></i>District
            </label>
            <input type="text" name="district" class="form-control"
                   placeholder="e.g. Pune" value="{{ district }}">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="bi bi-basket me-2 text-success"></i>Commodity <span class="text-danger">*</span>
            </label>
            <select name="commodity" class="form-select" required>
              {% for c in commodities %}
              <option value="{{ c }}" {% if c == commodity %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Row 2: Date From, Date To, Sort By, Order, Submit -->
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-event me-2 text-success"></i>Arrival Date From
            </label>
            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
            <small class="text-muted">Today's data may not be submitted yet</small>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-check me-2 text-success"></i>Arrival Date To
            </label>
            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="bi bi-sort-down me-2 text-success"></i>Sort By
            </label>
            <select name="sort_by" class="form-select">
              {% for val, label in sort_fields %}
              <option value="{{ val }}" {% if val == sort_by %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">Order</label>
            <select name="sort_order" class="form-select">
              <option value="asc"  {% if sort_order == "asc"  %}selected{% endif %}>Ascending</option>
              <option value="desc" {% if sort_order == "desc" %}selected{% endif %}>Descending</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-search me-2"></i>Get Prices
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Error -->
    {% if error %}
    <div class="alert alert-warning d-flex align-items-center gap-2" data-aos="fade-up">
      <i class="bi bi-exclamation-triangle-fill fs-5"></i>
      <span>{{ error }}</span>
    </div>
    {% endif %}

    <!-- Results -->
    {% if records %}
    {% set prices = records | map(attribute='modal_price') | map('float') | list %}
    {% set min_p  = records | map(attribute='min_price')   | map('float') | list %}
    {% set max_p  = records | map(attribute='max_price')   | map('float') | list %}
    {% set avg    = (prices | sum / prices | length) | round(2) %}
    {% set loc    = district if district else (state if state else "India") %}

    <!-- Stat Cards -->
    <div class="row g-4 mb-5" data-aos="fade-up">
      <div class="col-6 col-md-3">
        <div class="market-stat-card">
          <div class="market-stat-icon bg-success bg-opacity-10 text-success">
            <i class="bi bi-graph-down"></i>
          </div>
          <div class="market-stat-value text-success">₹{{ min_p | min | int }}</div>
          <div class="market-stat-label">Min Price (₹/quintal)</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="market-stat-card">
          <div class="market-stat-icon bg-danger bg-opacity-10 text-danger">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="market-stat-value text-danger">₹{{ max_p | max | int }}</div>
          <div class="market-stat-label">Max Price (₹/quintal)</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="market-stat-card">
          <div class="market-stat-icon bg-primary bg-opacity-10 text-primary">
            <i class="bi bi-calculator"></i>
          </div>
          <div class="market-stat-value text-primary">₹{{ avg }}</div>
          <div class="market-stat-label">Avg Modal Price (₹/quintal)</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="market-stat-card">
          <div class="market-stat-icon bg-warning bg-opacity-10 text-warning">
            <i class="bi bi-list-ol"></i>
          </div>
          <div class="market-stat-value text-warning">{{ records | length }}</div>
          <div class="market-stat-label">Total Records</div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="market-chart-card tool-card mb-5" data-aos="fade-up">
      <h5 class="mb-4">
        <i class="bi bi-bar-chart-fill text-success me-2"></i>
        {{ commodity }} – Modal Prices in {{ loc }}
      </h5>
      <canvas id="priceChart" height="100"></canvas>
    </div>

    <!-- Table + CSV -->
    <div class="market-table-card tool-card" data-aos="fade-up">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h5 class="mb-0">
          <i class="bi bi-table text-success me-2"></i>Detailed Records
        </h5>
        <a href="{{ url_for('market_prices',
                   commodity=commodity, state=state, district=district,
                   date_from=date_from, date_to=date_to,
                   sort_by=sort_by, sort_order=sort_order,
                   export='csv') }}"
           class="btn btn-outline-success btn-sm">
          <i class="bi bi-download me-1"></i>Download CSV
        </a>
      </div>
      <div class="table-responsive">
        <table class="table market-table table-hover align-middle">
          <thead class="table-success">
            <tr>
              <th>#</th>
              <th>State</th>
              <th>District</th>
              <th>Market</th>
              <th>Commodity</th>
              <th>Variety</th>
              <th>Arrival Date</th>
              <th>Min (₹)</th>
              <th>Max (₹)</th>
              <th>Modal (₹)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in records %}
            <tr>
              <td class="text-muted small">{{ loop.index }}</td>
              <td>{{ r.state }}</td>
              <td>{{ r.district }}</td>
              <td>{{ r.market }}</td>
              <td>{{ r.commodity }}</td>
              <td>{{ r.variety }}</td>
              <td>{{ r.arrival_date }}</td>
              <td class="text-success fw-semibold">{{ r.min_price }}</td>
              <td class="text-danger fw-semibold">{{ r.max_price }}</td>
              <td class="text-primary fw-bold">{{ r.modal_price }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart.js Script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script>
      const labels  = {{ records | map(attribute='market') | list | tojson }};
      const modals  = {{ records | map(attribute='modal_price') | map('float') | list | tojson }};
      const mins    = {{ records | map(attribute='min_price')   | map('float') | list | tojson }};
      const maxes   = {{ records | map(attribute='max_price')   | map('float') | list | tojson }};

      new Chart(document.getElementById('priceChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Min Price',   data: mins,   backgroundColor: 'rgba(34,197,94,0.6)',  borderColor: '#16a34a', borderWidth: 1 },
            { label: 'Modal Price', data: modals, backgroundColor: 'rgba(59,130,246,0.6)', borderColor: '#2563eb', borderWidth: 1 },
            { label: 'Max Price',   data: maxes,  backgroundColor: 'rgba(239,68,68,0.6)',  borderColor: '#dc2626', borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { ticks: { maxRotation: 45, minRotation: 30 } },
            y: { beginAtZero: false, title: { display: true, text: '₹ / quintal' } }
          }
        }
      });
    </script>
    {% endif %}

  </div>
</section>

{% endblock %}
